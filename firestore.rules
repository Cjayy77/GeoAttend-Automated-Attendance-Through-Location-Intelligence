rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user document exists
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Check if user is a lecturer
    function isLecturer() {
      return isAuthenticated() && userExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'lecturer';
    }
    
    // Check if user is a student
    function isStudent() {
      return isAuthenticated() && userExists() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    // Check if user owns this UID
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    // Check if document was created more than 7 days ago
    function isOldRecord(createTime) {
      return request.time > createTime + duration.value(7, 'd');
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{userId} {
  allow create: if request.auth != null
                && request.auth.uid == userId;

  allow read, update: if request.auth != null
                      && request.auth.uid == userId;

  allow delete: if false;
}

    
    // ============================================
    // SESSIONS COLLECTION
    // ============================================
    
    match /sessions/{sessionId} {
      // Allow lecturers to create sessions
      allow create: if isLecturer()
        && request.resource.data.lecturerId == request.auth.uid
        && request.resource.data.hasAll(['lecturerId', 'lecturerName', 'radius', 'active'])
        && request.resource.data.lecturerId is string
        && request.resource.data.lecturerName is string
        && request.resource.data.radius is number
        && request.resource.data.radius > 0
        && request.resource.data.active is bool;
      
      // Allow lecturers to read/update their own sessions, students to read all
      allow read: if
        (request.auth != null
         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'lecturer'
         && resource.data.lecturerId == request.auth.uid)
        || (request.auth != null
         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student');
      
      allow update: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'lecturer'
        && resource.data.lecturerId == request.auth.uid;
      
      // Allow lecturers to delete their own sessions
      allow delete: if isLecturer() && resource.data.lecturerId == request.auth.uid;
    }
    
    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    
   match /attendance/{attendanceId} {

  allow create: if isStudent()
    && request.resource.data.studentId == request.auth.uid;

  allow read: if isStudent() && resource.data.studentId == request.auth.uid
              || isLecturer();

  allow update: if request.auth != null
                && resource.data.studentId == request.auth.uid;

  allow delete: if isLecturer();
}

    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    // Deny all access to other collections/documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
